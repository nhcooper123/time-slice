% Preamble
\documentclass[12pt,a4paper]{article}
\usepackage{enumerate} 	
\usepackage{setspace}						
\usepackage{authblk}	
\usepackage{graphicx} 	
%\usepackage[nomarkers, nolists]{endfloat} 
\usepackage{pdflscape}	
\usepackage{mathtools}	
\usepackage[osf]{mathpazo} 
\usepackage{lineno} 
\usepackage{ms}    	
\usepackage{hyperref}
\usepackage[round]{natbib} 
\usepackage{setspace}

\setcounter{secnumdepth}{0} 
\raggedright 			
\pagenumbering{arabic}	
\linenumbers


% First order headings upper case bold
\usepackage{titlesec}
\titleformat*{\section}{\small\bfseries\uppercase}

% Second order headings normal case italics
\titleformat*{\subsection}{\small\itshape}

% Third order, italics, paragraph style
\titleformat*{\paragraph}{\small\itshape}


% lists - arabic in (1; (2); (3) .


% Title page information

\title{Time for a rethink: disparity-through-time}

\author{
	Thomas Guillerme$^{1*}$ and Natalie Cooper$^{2}$
}

\date{}

\affiliation{\noindent{\footnotesize
	$^1$Thomas address\\ 
	$^2$Department of Life Sciences, Natural History Museum, Cromwell Road, London, SW7 5BD, UK. natalie.cooper@nhm.ac.uk}\\
	$^*$Corresponding author\\}

\vfill

\runninghead{Time slicing}
\keywords{??} 
% up to 6

\begin{document}

\mstitlepage
\parindent = 1.5em
\addtolength{\parskip}{.3em}

\section{Abstract}
% 300 words max
	

\newpage
\raggedright
\doublespacing
\setlength{\parindent}{1cm}

\section{Introduction}
Disparity-through-time analyes are common in palaeontology.
Examples
They often provide us with exciting insights into mass extinctions, competitive replacements etc.
However, our methods for analysing diversity-through-time have not changed all that much in the XX years they have been popular. 
The way we perfrom these analyses may have profound effects on our conclusions.

One aspect that is not always carefully considered, is how to divide taxa into subsets through time. The nature of disparity, i.e. a diversity metric, means it cannot be calculated using just one individual, so some way of subsetting taxa is required.

Stratigraphy
Time bins
Time slicing (requires a phylogeny)

Changes in disparity through time are generally investigated by calculating the disparity of taxa that occupy the cladisto-space during specific time intervals \citep[e.g][]{cisneros2010,prentice2011,Hughes20082013,hopkinsdecoupling2013,bentonmodels2014,bensonfaunal2014}.
These time intervals are usually defined based on biostratigraphy \citep[e.g.][]{cisneros2010,prentice2011,Hughes20082013,bentonmodels2014} but can also be arbitrarily chosen time periods of equal duration \citep{Butler2012,hopkinsdecoupling2013,bensonfaunal2014}.
However, this approach suffers from two main biases. 
First, if biostratigraphy is used to determine the time intervals, disparity may be distorted towards higher differences between time intervals because biostratigraphical periods are geologically defined based on differences in the morphology of fossils found in the different strata.
Second, this approach assumes that all characters evolve following a punctuated equilibrium model, because disparity is only estimated once for each interval resulting in all changes in disparity occurring between intervals, rather than also allowing for gradual changes within intervals \citep{Hunt21042015}.

To address these issues, we used a ``time-slicing'' approach that considers subsets of taxa in the cladisto-space at specific equidistant points in time, as opposed to considering subsets of taxa between two points in time.
This results in even-sampling of the cladisto-space across time and permits us to define the underlying model of character evolution (punctuated or gradual).  
In practice, time-slicing considers the disparity of any element present in the phylogeny (branches, nodes and tips) at any point in time.

We present this using five datasets collated from the literature.

\section{Materials and Methods}
\subsection{Overview}
\label{overview-section}
% I'm unsure if this section is needed or not. The methods are long so it might help?
To test the different time subsampling methods, we followed the protocol below. 
Note that all the code needed to reproduce these analyses (along with detailed instructions) is provided HERE.

\begin{enumerate}
  \item Collating example datasets. Disparity-through-time analysis requires a matrix containing morphological characters for each taxon, and information on the first and last occurrence dates of each taxon. Time slicing methods also require a phylogeny.
  \item Processing example datasets. Various transformations of the datasets are required before the analyses can take place. We need to estimate ancestral character states at the nodes of the phylogeny for the time slicing methods, build cladisto-spaces via distance matrices and ordination, and remove taxa from the phylogeny that are missing from the matrix and vice versa.   
  \item Time subsampling
  \item Estimate disparity for each time subsample
  \item Compare different methods
\end{enumerate}


\subsection{Example datasets}
\label{datasets}
To test the different time binning/slicing methods we selected five datasets (see Table \ref{datasets}). 
Note that although disparity-through-time analyses are possible without a phylogeny, we only use examples with phylogenies here so that we can compare results of time slicing methods, which do require a phylogeny. 
Each dataset consists of a set of first and last occurrence dates for all taxa, a matrix of morphological characters in NEXUS format, and a time-scaled phylogeny. 
More details on these datasets can be found in the appendix. All data are available HERE. And the processing code too. Probably also want to link to Dryad etc. HERE

  \begin{table}[!htbp]      
    \caption[Datasets.]
    {Dataset captions}
    \input{tables/datasets.tex} 
    \label{tab:data}  
  \end{table}

\subsection{Estimating ancestral character states}
\label{ace}
For each dataset we used the re-rooting method \citep{Yang01121995,Garland2000} to get Maximum Likelihood estimates of the ancestral states for each character at every node in the phylogeny, using the \texttt{rerootingMethod} function from the \texttt{R} package \texttt{phytools} version 0.4-45 \citep{phytools,R}. % Version still the same?
Where there were missing character data for a taxon we followed the method of \cite{Claddis} and treated missing data as any possible observed state for each character.
For example, if a character had two observed states ($0$ and $1$) across all taxa, we attributed the multi-state ``$0$\&$1$" value to the taxon with missing data, representing an equal probability of being either $0$ or $1$.
This allows the ancestral node of a taxon with missing data to be estimated with no assumptions other than that the taxon has one of the observed character states.
To prevent poor ancestral state reconstructions from biasing our results, especially when a lot of error is associated with the reconstruction, we only included ancestral state reconstructions with a scaled Likelihood $\geq$ $0.95$.
Ancestral state reconstructions with scaled Likelihoods below this threshold were recoded as missing data (``?'').

\subsection{Building cladisto-spaces} 
To explore disparity-through-time in our datasets we used a cladisto-space approach \citep[e.g.][]{Foote01071994,Foote29111996,Wesley-Hunt2005,Brusatte12092008,friedmanexplosive2010,toljagictriassic-jurassic2013,Hughes20082013}.
This approach is similar to constructing a morphospace based on continuous morphological data \citep[e.g.][]{friedmanexplosive2010}, except a cladisto-space is an approximation of the morphospace based on cladistic data (i.e. the discrete morphological characters used to build a phylogenetic tree).
Mathematically, a cladisto-space is an $n$ dimensional object that summarises the cladistic distances between the taxa present in a cladistic matrix.
Although empirically inter-taxon distances are the same in a morphospace or a cladisto-space \citep{foth2012different,hetherington2015cladistic}, we prefer the term cladisto-space to make it clear that this space is estimated using cladistic data and not morphometric data.

\paragraph{Constructing distance matrices.}
To estimate the cladisto-spaces for each of our datasets we first constructed pairwise distance matrices of length $k$, where $k$ is the total number of tips and nodes in the dataset.
We calculated the $k$$\times$$k$ distances using the Gower distance \citep{Gower71}, i.e. the Euclidean distance between two taxa divided by the number of shared characters. 
This allows us to correct for distances between two taxa that share many characters and could be closer to each other than to taxa with fewer characters in common (i.e. because some pairs of taxa share more characters in common than others, they are more likely to be similar).
For cladistic matrices, using this corrected distance is preferable to the raw Euclidean distance because of its ability to deal with discrete or/and ordinated characters as well as with missing data \citep{anderson2012using}.
However, the Gower distance cannot calculate distances when taxa have no overlapping data.
Therefore, we used the \texttt{TrimMorphDistMatrix} function from the \texttt{Claddis} \texttt{R} package \citep{Claddis} to remove pairs of taxa with no cladistic characters in common.
This led to us removing nine taxa from the BAPST dataset, and 19 from the Brusatte dataset, but none from the other three datasets (see code for details of which species). % add citations

\paragraph{Ordination.}
After constructing our distance matrices we transformed them using classical multidimensional scaling \citep[MDS;][]{torgerson1965multidimensional,GOWER01121966,cailliez1983analytical}.
This method (also referred to as PCO; e.g. \citealt{Brusatte2015}; or PCoA; e.g. \citealt{paradisape:2004}) is an eigen decomposition of the distance matrix.
Because we used Gower distances instead of raw Euclidean distances, negative eigenvalues can be calculated.
To avoid this problem, we first transformed the distance matrices by applying the Cailliez correction \citep{cailliez1983analytical} which adds a constant $c^*$ to the values in a distance matrix (apart from the diagonal) so that all the Gower distances become Euclidean ($d_{Gower}+c^*=d_{Euclidean}$; \citealt{cailliez1983analytical}). 
We were then able to extract $n$ eigenvectors for each matrix (representing the $n$ dimensions of the cladisto-space) where $n$ is equal to $k-2$, i.e. the number of taxa in the matrix ($k$) minus the last two eigenvectors that are always null after applying the Cailliez correction.
Contrary to previous studies \citep[e.g][]{brusatte50,cisneros2010,prentice2011,anderson2012using,Hughes20082013,bentonmodels2014}, we use all $n$ dimensions of our cladisto-spaces and not a subsample representing the majority of the variance in the distance matrix (e.g. selecting only $m$ dimensions that represent up to 90\% of the variance in the distance matrix; \citealt{Brusatte12092008,toljagictriassic-jurassic2013}).

Note that our cladisto-spaces represent an ordination of all possible morphologies coded in each study through time.
It is unlikely that all morphologies will co-occur at each time point, therefore, the disparity of the whole cladisto-space is expected to be greater than the disparity at any specific point in time.

\subsection{Calculating disparity}
\label{disparity_calc}
Disparity can be estimated in many different ways \citep[e.g.][]{Wills1994,Ciampaglio2004,thorneresetting2011,hopkinsdecoupling2013,huang2015origins}, however most studies estimate disparity using four metrics: the sum and products of ranges and variances, each of which gives a slightly different estimate of how the data fits within the cladisto-space \citep{Foote01071994,Wills1994,brusatte50,Brusatte12092008,cisneros2010,thorneresetting2011,prentice2011,brusattedinosaur2012,toljagictriassic-jurassic2013,ruta2013,bentonmodels2014,bensonfaunal2014}.
However, these metrics have limitations. 
First, the range metrics are affected by the uneven sampling of the fossil record \citep{Butler2012}.
Second, because we include all $n$ dimensions in the analysis (see above), the products of ranges and variances will tend towards zero since the scores of the last dimension are usually really close to zero themselves. 
We therefore use the sum of variances metric to estimate disparity.

\subsection{Estimating disparity-through-time} 
\label{time_slicing}

To estimate disparity-through-time we first need to split the data into time subsamples.
Here we explore the following scenarios.

\begin{enumerate}
  \item Stratigraphic time bins. This is the traditional method, where all the taxa within each stratigraphic period are included in the disparity calculation. This often leads to bins of unequal duration. Here we use stratigraphic ages and epochs.
  \item Equally sized time bins. This is another commonly used method, where the time frame of interest is split into equally sized time bins, then all the taxa within each time bin are included in the disparity calculation. Here we use three different methods to determine the size of the time bins. 
    \begin{enumerate}
      \item The *duration* of the bin is equal to the median duration of the stratigraphic period (age or epoch).
      \item The *number* of bins is equal to the number of stratigraphic periods (ages or epochs).
      \item The *number* of bins is either 2, 5, 10, 15, or 20.
    \end{enumerate}
  \item Time slicing. This method uses a phylogeny, and rather than binning the data, it takes slices through a phylogeny and includes all the taxa and nodes in that slice within the disparity calculation. Here we use three different methods to determine the intervals between the time slices.
    \begin{enumerate}
      \item The *interval* between slices is equal to the median duration of the stratigraphic period (age or epoch).
      \item The *number* of slices is equal to the number of stratigraphic periods (ages or epochs).
      \item The *number* of slices is either 2, 5, 10, 15, or 20.
    \end{enumerate}  
\end{enumerate}

% Might make a table with all the subsets???
% Had a play - it's COMPLICATED!!!

  \begin{table}[!htbp]      
    \caption[Subsamples.]
    {captions}
    \input{tables/timesamples.tex} 
    \label{tab:subsamples}  
  \end{table}

% Just tips or tips and nodes????
\paragraph{Stratigraphic time bins.}
We extracted the taxa found in each geological age or epoch from each cladisto-space.
For each subsample, we estimated its disparity.
To reduce the influence of outliers on our disparity estimates, we bootstrapped each disparity measurement by randomly resampling with replacement a new subsample of taxa from the observed taxa in the subsample 1000 times.
We then calculated the median disparity value for each subsample along with the 50\% and 95\% confidence intervals.
We also recorded the number of taxa in each subsample as a proxy for taxonomic diversity (Table \ref{tab:subsamples}).

\paragraph{Equally sized time bins.}
We extracted the taxa found in each time bin for each cladisto-space.
We varied the size of the time bins so that either (i) the *duration* of the bin is equal to the median duration of the stratigraphic age or epoch, (ii) the *number* of bins is equal to the number of stratigraphic ages or epochs, (iii) or by using 2, 5, 10, 15, or 20 bins.
For each subsample, we estimated its disparity and bootstrapped each disparity measurement as described above for stratigraphic time bins.
We also recorded the number of taxa in each subsample as a proxy for taxonomic diversity (Table \ref{tab:subsamples}).

\paragraph{Time slicing.} % THOMAS TO UPDATE THIS BIT!!!
The ``time-slicing'' approach considers subsets of taxa in the cladisto-space at specific equidistant points in time, as opposed to considering subsets of taxa between two points in time.
This results in even-sampling of the cladisto-space across time and permits us to define the underlying model of character evolution (punctuated or gradual % and others ADD).  
In practice, time-slicing considers the disparity of any element present in the phylogeny (branches, nodes and tips) at any point in time.
When the phylogenetic elements are nodes or tips, the eigenvector scores for the nodes (estimated using ancestral state reconstruction as described in section \ref{ace}) or tips are directly used for estimating disparity.
When the phylogenetic elements are branches we chose the eigenvector score for the branch using one of two evolutionary models:
\begin{enumerate}
    \item{\textbf{Punctuated evolution.}} 
    This model selects the eigenvector score from either the ancestral node or the descendant node/tip of the branch regardless of the position of the slice along the branch. 
    Similarly to the time interval approach, this reflects a model of punctuated evolution where changes in disparity occur either at the start or at the end of a branch over a relatively short time period and clades undergo long periods of stasis during their evolution \citep{Gould1977,Hunt20112007}.
    We applied this model in three ways: 
    \begin{enumerate}[(i)]
      \item selecting the eigenvector score of the ancestral node of the branch (ACCTRAN).
      \item selecting the eigenvector score of the descendant node/tip of the branch (DELTRAN).
      \item randomly selecting either the eigenvector score of the ancestral node or the descendant node/tip of the branch (random).
    \end{enumerate}
    Method (i) assumes that changes always occur early on the branch (accelerated transition, ACCTRAN) and (ii) assumes that changes always occur later (delayed transition, DELTRAN).
    We prefer not to make either assumption so we report the results from (iii), although the ACCTRAN and DELTRAN results are available in the appendix \ref{chap:Appendix_STD} (Fig. \ref{Supp_disparity_all_Mammaliaformes}, \ref{Supp_disparity_all_Eutheria}, \ref{Supp_disparity_all_Mammaliaformes_rarefied}, \ref{Supp_disparity_all_Eutheria_rarefied}).
    \item{\textbf{Gradual evolution.}}
    This model also selects the eigenvector score from either the ancestral node or the descendant node/tip of the branch, but the choice depends on the distance between the sampling time point and the end of the branch.
    If the sampling time point falls in the first half of the branch length the eigenvector score is taken from the ancestral node, conversely, if the sampling time point falls in the second half of the branch length the eigenvector score is taken from the descendant node/tip.
    This reflects a model of gradual evolution where changes in disparity are gradual and cumulative along the branch.
    Under this model, the gradual changes could be either directional or random, however, directional evolution has been empirically shown to be rare \citep[only 5\% of the time][]{Hunt20112007}.
    We therefore considered that changes from a character state A to B were only dependent on the branch length.
\end{enumerate}

We applied our time-slicing approach separately to each cladisto-space.
We varied the intervals between time slices so that either (i) the *interval* between slices is equal to the median duration of the stratigraphic age or epoch; (ii) the *number* of slices is equal to the number of stratigraphic ages or epochs, or (iii) by setting the *number* of slices to 2, 5, 10, 15, or 20.
For each subsample, we estimated its disparity assuming punctuated (ACCTRAN, DELTRAN and random) and gradual evolution as described above. % NEED TO ADD THE NEW MODELS.
To reduce the influence of outliers on our disparity estimates, we bootstrapped each disparity measurement as described above for the stratigraphic time bins. 
We also recorded the number of phylogenetic elements (nodes and tips) in each subsample as a proxy for taxonomic diversity (Table \ref{tab:subsamples}).

\subsection{Comparing the results}
%Testing the difference section


	
\section{Results} 

%Fig. or Figs
%Fig width 80mm single column
%110mm - 2/3 width
%166mm full page


	
%PCA figure
	%\begin{figure}[!htbp]
	%\centering
	%\includegraphics[width=1\linewidth, height=1\textheight, keepaspectratio]{figures/PCA_threeplot.png}
	%\caption[Morphospace (principal components) plot of morphological diversity in tenrec and golden mole skulls.]
	%	{Principal components plots of the morphospaces occupied by tenrecs (triangles, n=31 species) and golden moles (circles, n=12 species) for skulls in dorsal (top left), ventral (top right) and lateral (bottom left) views. Each point represents the average skull shape of an individual species. Axes are principal component 1 (PC1) and principal component 2 (PC2) of the average scores from principal components analyses of mean Procrustes shape coordinates for each species.}
	%\label{fig:threePCA}
	%\end{figure}


% Results table
	%\begin{table}[!htbp]			
		%\caption[Comparing morphological diversity in tenrecs and golden moles.]
		%{Morphological diversity in tenrecs compared to golden moles (12 species). N is the number of tenrec species: 31 species or 17 species including just five representatives of the \textit{Microgale} Genus. Morphological diversity of the Family is the mean Euclidean distance from each species to the Family centroid. Significant differences between the two Families (p$<$0.05) from two-tailed t-tests are highlighted in bold.}
		%\input{tables/diversity.results} 
		%\label{tab:diversity}  
	%\end{table}
	

\section{Discussion}


\section{Conclusions}
	

\section{Acknowledgments}
	We thank all the PalAss folk
	
\bibliographystyle{sysbio} 
\bibliography{time-refs} 

\end{document}