---
title: "Figure 1: disparity through time - simplified and for appendix"
author: "Natalie Cooper"
date: "`r Sys.Date()`"
output:
  html_document:
    fig_width: 12
    fig_height: 6
---

```{r, message = FALSE}
library(tidyverse)
library(gridExtra)
source("../functions/multiplot_fun.R")
```


```{r}
slug <- "Beck2014"
```

Load the data 

```{r}
out1 <- readRDS(file = paste0("../outputs/epoch.", slug, ".Rda"))

strat <- out1$results$stratigraphy
duration <- out1$results$duration
number <- out1$results$number
```

Get the data into the correct format to plot

```{r}
# Stratigraphy
# Get ages for the bins, go for the midpoints
x <- str_split(strat$subset, " - ") 
y <- map(x, as.numeric)
z <- map(y, mean)

# Modify data - add midpoints, remove missing data, filter to just two models,
# make disparity relative by dividing by max values
strat2 <- 
  strat %>%
  mutate(time = unlist(z)) %>%
  filter(bs.median != 0 & !is.na(bs.median)) %>%
  filter(model == "equalbins" | model == "proximity" | model == "gradual.split") %>%
  mutate(relative.disparity = bs.median/max(bs.median)) %>%
  mutate(relative.lwr = `2.5%`/max(bs.median)) %>%
  mutate(relative.upr = `97.5%`/max(bs.median))

# Duration
x <- str_split(duration$subset, " - ") 
y <- map(x, as.numeric)
z <- map(y, mean)

duration2 <- 
  duration %>%
  mutate(time = unlist(z)) %>%
  filter(bs.median != 0 & !is.na(bs.median)) %>%
  filter(model == "equalbins" | model == "proximity" | model == "gradual.split") %>%
  mutate(relative.disparity = bs.median/max(bs.median)) %>%
  mutate(relative.lwr = `2.5%`/max(bs.median)) %>%
  mutate(relative.upr = `97.5%`/max(bs.median))

# Number
x <- str_split(number$subset, " - ") 
y <- map(x, as.numeric)
z <- map(y, mean)

number2 <- 
  number %>%
  mutate(time = unlist(z)) %>%
  filter(bs.median != 0 & !is.na(bs.median)) %>%
  filter(model == "equalbins" | model == "proximity" | model == "gradual.split") %>%
  mutate(relative.disparity = bs.median/max(bs.median)) %>%
  mutate(relative.lwr = `2.5%`/max(bs.median)) %>%
  mutate(relative.upr = `97.5%`/max(bs.median))
```

Make plots in preparation for larger grid plot below

```{r}

beck_base <- 
  ggplot(strat2, aes(y = relative.disparity, x = time, colour = model)) +
  theme_classic(base_size = 16) + 
  scale_y_continuous(breaks = seq(0, 1, 0.2), 
                     labels = seq(0, 1, 0.2)) +
  scale_x_reverse(limits = c(100, 0)) +
  expand_limits(x = 0, y = 0)
  theme(axis.title.y = element_blank(),
        axis.title.x = element_blank(),
        legend.position = "none")

beck_s <- 
  beck_base +
  geom_point(data = strat2, size = 2, alpha = 0.8) +
  geom_errorbar(data = strat2, aes(ymin = relative.lwr, ymax = relative.upr), width = 1, alpha = 0.8)
  
beck_d <- 
  beck_base +
  geom_point(data = duration2, size = 2, alpha = 0.8) +
  geom_errorbar(data = duration2, aes(ymin = relative.lwr, ymax = relative.upr), width = 1, alpha = 0.8)

beck_n <- 
  beck_base +
  geom_point(data = number2, size = 2, alpha = 0.8) +
  geom_errorbar(data = number2, aes(ymin = relative.lwr, ymax = relative.upr), width = 1, alpha = 0.8)

```

Pick the slug

```{r}
slug <- "Brusatte2014"
```

Load the data 

```{r}
out1 <- readRDS(file = paste0("../outputs/epoch.", slug, ".Rda"))

strat <- out1$results$stratigraphy
duration <- out1$results$duration
number <- out1$results$number
```

Get the data into the correct format to plot

```{r}
# Stratigraphy
# Get ages for the bins, go for the midpoints
x <- str_split(strat$subset, " - ") 
y <- map(x, as.numeric)
z <- map(y, mean)

# Modify data - add midpoints, remove missing data, filter to just two models
strat2 <- 
  strat %>%
  mutate(time = unlist(z)) %>%
  filter(bs.median != 0 & !is.na(bs.median)) %>%
  filter(model == "equalbins" | model == "proximity" | model == "gradual.split") %>%
  mutate(relative.disparity = bs.median/max(bs.median)) %>%
  mutate(relative.lwr = `2.5%`/max(bs.median)) %>%
  mutate(relative.upr = `97.5%`/max(bs.median))

# Duration
x <- str_split(duration$subset, " - ") 
y <- map(x, as.numeric)
z <- map(y, mean)

duration2 <- 
  duration %>%
  mutate(time = unlist(z)) %>%
  filter(bs.median != 0 & !is.na(bs.median)) %>%
  filter(model == "equalbins" | model == "proximity" | model == "gradual.split") %>%
  mutate(relative.disparity = bs.median/max(bs.median)) %>%
  mutate(relative.lwr = `2.5%`/max(bs.median)) %>%
  mutate(relative.upr = `97.5%`/max(bs.median))

# Number
x <- str_split(number$subset, " - ") 
y <- map(x, as.numeric)
z <- map(y, mean)

number2 <- 
  number %>%
  mutate(time = unlist(z)) %>%
  filter(bs.median != 0 & !is.na(bs.median)) %>%
  filter(model == "equalbins" | model == "proximity" | model == "gradual.split") %>%
  mutate(relative.disparity = bs.median/max(bs.median)) %>%
  mutate(relative.lwr = `2.5%`/max(bs.median)) %>%
  mutate(relative.upr = `97.5%`/max(bs.median))
```

Make plots in preparation for larger grid plot below

```{r}

brusatte_base <- 
  ggplot(strat2, aes(y = relative.disparity, x = time, colour = model)) +
  theme_classic(base_size = 16) + 
  scale_y_continuous(breaks = seq(0, 1, 0.2), 
                     labels = seq(0, 1, 0.2)) +
  scale_x_reverse(limits = c(100, 0)) +
  expand_limits(x = 0, y = 0)
  theme(axis.title.y = element_blank(),
        axis.title.x = element_blank(),
        legend.position = "none")

brusatte_s <- 
  brusatte_base +
  geom_point(data = strat2, size = 2, alpha = 0.8) +
  geom_errorbar(data = strat2, aes(ymin = relative.lwr, ymax = relative.upr), width = 1, alpha = 0.8)
  
brusatte_d <- 
  brusatte_base +
  geom_point(data = duration2, size = 2, alpha = 0.8) +
  geom_errorbar(data = duration2, aes(ymin = relative.lwr, ymax = relative.upr), width = 1, alpha = 0.8)

brusatte_n <- 
  brusatte_base +
  geom_point(data = number2, size = 2, alpha = 0.8) +
  geom_errorbar(data = number2, aes(ymin = relative.lwr, ymax = relative.upr), width = 1, alpha = 0.8)

```

```{r}
slug <- "Bapst2016"
```

Load the data 

```{r}
out1 <- readRDS(file = paste0("../outputs/epoch.", slug, ".Rda"))

strat <- out1$results$stratigraphy
duration <- out1$results$duration
number <- out1$results$number
```

Get the data into the correct format to plot

```{r}
# Stratigraphy
# Get ages for the bins, go for the midpoints
x <- str_split(strat$subset, " - ") 
y <- map(x, as.numeric)
z <- map(y, mean)

# Modify data - add midpoints, remove missing data, filter to just two models
strat2 <- 
  strat %>%
  mutate(time = unlist(z)) %>%
  filter(bs.median != 0 & !is.na(bs.median)) %>%
  filter(model == "equalbins" | model == "proximity" | model == "gradual.split") %>%
  mutate(relative.disparity = bs.median/max(bs.median)) %>%
  mutate(relative.lwr = `2.5%`/max(bs.median)) %>%
  mutate(relative.upr = `97.5%`/max(bs.median))

# Duration
x <- str_split(duration$subset, " - ") 
y <- map(x, as.numeric)
z <- map(y, mean)

duration2 <- 
  duration %>%
  mutate(time = unlist(z)) %>%
  filter(bs.median != 0 & !is.na(bs.median)) %>%
  filter(model == "equalbins" | model == "proximity" | model == "gradual.split") %>%
  mutate(relative.disparity = bs.median/max(bs.median)) %>%
  mutate(relative.lwr = `2.5%`/max(bs.median)) %>%
  mutate(relative.upr = `97.5%`/max(bs.median))

# Number
x <- str_split(number$subset, " - ") 
y <- map(x, as.numeric)
z <- map(y, mean)

number2 <- 
  number %>%
  mutate(time = unlist(z)) %>%
  filter(bs.median != 0 & !is.na(bs.median)) %>%
  filter(model == "equalbins" | model == "proximity" | model == "gradual.split") %>%
  mutate(relative.disparity = bs.median/max(bs.median)) %>%
  mutate(relative.lwr = `2.5%`/max(bs.median)) %>%
  mutate(relative.upr = `97.5%`/max(bs.median))
```

Make plots in preparation for larger grid plot below

```{r}

bapst_base <- 
  ggplot(strat2, aes(y = relative.disparity, x = time, colour = model)) +
  theme_classic(base_size = 16) + 
  scale_y_continuous(breaks = seq(0, 1, 0.2), 
                     labels = seq(0, 1, 0.2)) +
  scale_x_reverse(limits = c(100, 0)) +
  expand_limits(x = 0, y = 0)
  theme(axis.title.y = element_blank(),
        axis.title.x = element_blank(),
        legend.position = "none")

bapst_s <- 
  bapst_base +
  geom_point(data = strat2, size = 2, alpha = 0.8) +
  geom_errorbar(data = strat2, aes(ymin = relative.lwr, ymax = relative.upr), width = 1, alpha = 0.8)
  
bapst_d <- 
  bapst_base +
  geom_point(data = duration2, size = 2, alpha = 0.8) +
  geom_errorbar(data = duration2, aes(ymin = relative.lwr, ymax = relative.upr), width = 1, alpha = 0.8)

bapst_n <- 
  bapst_base +
  geom_point(data = number2, size = 2, alpha = 0.8) +
  geom_errorbar(data = number2, aes(ymin = relative.lwr, ymax = relative.upr), width = 1, alpha = 0.8)

```

```{r}
slug <- "Wright2017"
```

Load the data 

```{r}
out1 <- readRDS(file = paste0("../outputs/epoch.", slug, ".Rda"))

strat <- out1$results$stratigraphy
duration <- out1$results$duration
number <- out1$results$number
```

Get the data into the correct format to plot

```{r}
# Stratigraphy
# Get ages for the bins, go for the midpoints
x <- str_split(strat$subset, " - ") 
y <- map(x, as.numeric)
z <- map(y, mean)

# Modify data - add midpoints, remove missing data, filter to just two models
strat2 <- 
  strat %>%
  mutate(time = unlist(z)) %>%
  filter(bs.median != 0 & !is.na(bs.median)) %>%
  filter(model == "equalbins" | model == "proximity" | model == "gradual.split") %>%
  mutate(relative.disparity = bs.median/max(bs.median)) %>%
  mutate(relative.lwr = `2.5%`/max(bs.median)) %>%
  mutate(relative.upr = `97.5%`/max(bs.median))

# Duration
x <- str_split(duration$subset, " - ") 
y <- map(x, as.numeric)
z <- map(y, mean)

duration2 <- 
  duration %>%
  mutate(time = unlist(z)) %>%
  filter(bs.median != 0 & !is.na(bs.median)) %>%
  filter(model == "equalbins" | model == "proximity" | model == "gradual.split") %>%
  mutate(relative.disparity = bs.median/max(bs.median)) %>%
  mutate(relative.lwr = `2.5%`/max(bs.median)) %>%
  mutate(relative.upr = `97.5%`/max(bs.median))

# Number
x <- str_split(number$subset, " - ") 
y <- map(x, as.numeric)
z <- map(y, mean)

number2 <- 
  number %>%
  mutate(time = unlist(z)) %>%
  filter(bs.median != 0 & !is.na(bs.median)) %>%
  filter(model == "equalbins" | model == "proximity" | model == "gradual.split") %>%
  mutate(relative.disparity = bs.median/max(bs.median)) %>%
  mutate(relative.lwr = `2.5%`/max(bs.median)) %>%
  mutate(relative.upr = `97.5%`/max(bs.median))
```

Make plots in preparation for larger grid plot below

```{r}

wright_base <- 
  ggplot(strat2, aes(y = relative.disparity, x = time, colour = model)) +
  theme_classic(base_size = 16) + 
  scale_y_continuous(breaks = seq(0, 1, 0.2), 
                     labels = seq(0, 1, 0.2)) +
  scale_x_reverse(limits = c(470, 370),
                  breaks = c(seq(470, 370, by = -20))) +
  expand_limits(x = 0, y = 0) +
  theme(axis.title.y = element_blank(),
        axis.title.x = element_blank())

wright_s <- 
  wright_base +
  geom_point(data = strat2, size = 2, alpha = 0.8) +
  geom_errorbar(data = strat2, aes(ymin = relative.lwr, ymax = relative.upr), width = 1, alpha = 0.8) +
  theme(legend.position = "none")
  
wright_d <- 
  wright_base +
  geom_point(data = duration2, size = 2, alpha = 0.8) +
  geom_errorbar(data = duration2, aes(ymin = relative.lwr, ymax = relative.upr), width = 1, alpha = 0.8) +
  theme(legend.position = "none")

wright_n <- 
  wright_base +
  geom_point(data = number2, size = 2, alpha = 0.8) +
  geom_errorbar(data = number2, aes(ymin = relative.lwr, ymax = relative.upr), width = 1, alpha = 0.8) +
  theme(legend.position = "none")

```

Finally plot them all together

```{r}
# Using modified multiplot function
# written by Scott Chamberlain
all <-   
  multiplot(beck_s, beck_d, beck_n,
            brusatte_s, brusatte_d, brusatte_n,
            bapst_s, bapst_d, bapst_n,
            wright_s, wright_d, wright_n,
            cols = 3, 
            labs = list("Time (MYA)", 
                        "Relative disparity"))

ggsave("../manuscript/figures/figure-dtt.png", all, 
       device = png(width = 600, height = 400))
```