---
title: "Outputs from time slice analyses"
author: "Natalie Cooper and Thomas Guillerme"
date: "`r Sys.Date()`"
output:
  html_document:
    fig_width: 6
    fig_height: 6
---

This code runs the output analyses in the paper, i.e. creates tables, figures and statistical tests.

```{r}
set.seed(123)
```

Load packages and functions
-----------------------------------

```{r, eval = TRUE, message = FALSE}
library(devtools)
library(ape)
library(tidyverse)
library(viridis)
library(dispRity) 
```

Loading the data
-----------------------------------

This script requires the outputs from `02-time-slice-analyses.Rmd`

```{r}
slug <- "Beck2014"
out1 <- readRDS(out1, file = paste0("../outputs/age.", slug, ".Rda"))
out2 <- readRDS(out2, file = paste0("../outputs/age.", slug, ".Rda"))
```

Examining the output 
--------------------

Outputs can be viewed using `out1$results$stratigraphy`, `out1$results$duration`, or `out1$results$number`.

The results as a table

```{r, eval = TRUE, echo = FALSE}
knitr::kable(out2$results$stratigraphy, caption = "Disparity per stratigraphic time: unequal time bins and non-equidistant time slices")
knitr::kable(out2$results$duration, caption = "Disparity per average stratigraphic time: equal time bins and equidistant time slices based on the median stratigraphic epoch duration")
knitr::kable(out2$results$number, caption = "Disparity per average stratigraphic time: equal time bins and equidistant time slices based on the number of stratigraphic epochs")
```

This is not really digest and we should find a better way to present that.
Anyway, these boring tables are always good for the supplementaries.

## Plotting the results `dispRity` style

Here is an example of the results using `plot.dispRity`.
The upper panel is with the CIs and the lower one is the same without the CIs.

### The results for the Age type

```{r, eval = TRUE, fig.width = 12, fig.height = 18, echo = TRUE}
op <- par(bty = "n", mfrow = c(3,2))
## Principal colors
colors <- palette()[1:5][-1] #TG: that can be made fancier
colors[5] <- "black"
## Color combination (for the CI)
colors_CI <- c("pink", "lightgreen", "lightblue", "lightcyan", "lightgray")
## y limits
ylim <- range(unlist(lapply(out1$results, function(X) return(c(min(X[,5], na.rm = TRUE), max(X[,5],
  na.rm = TRUE))))))
## Zooming
ylim_zoom <- c(20, 35)

## Plotting the different methods (with/without CIs)
plot.results.dispRity(out1$object, method = 1, colors = colors, colors_CI = colors_CI,
  main = "Stratigraphy", ylim = ylim, CI = TRUE, legend = TRUE)
plot.results.dispRity(out1$object, method = 1, colors = colors, colors_CI = colors_CI,
  main = "Stratigraphy (no CI)", ylim = ylim_zoom, CI = FALSE, time.bins.line = TRUE)

plot.results.dispRity(out1$object, method = 2, colors = colors, colors_CI = colors_CI,
  main = "Duration", ylim = ylim, CI = TRUE)
plot.results.dispRity(out1$object, method = 2, colors = colors, colors_CI = colors_CI,
  main = "Duration (no CI)", ylim = ylim_zoom, CI = FALSE, time.bins.line = TRUE)

plot.results.dispRity(out1$object, method = 3, colors = colors, colors_CI = colors_CI,
  main = "Number", ylim = ylim, CI = TRUE)
plot.results.dispRity(out1$object, method = 3, colors = colors, colors_CI = colors_CI,
  main = "Number (no CI)", ylim = ylim_zoom, CI = FALSE, time.bins.line = TRUE)
```

### The results for the Epoch type


```{r, eval = TRUE, fig.width = 12, fig.height = 18, echo = TRUE}
op <- par(bty = "n", mfrow = c(3,2))
## Principal colors
colors <- palette()[1:5][-1] #TG: that can be made fancier
colors[5] <- "black"
## Color combination (for the CI)
colors_CI <- c("pink", "lightgreen", "lightblue", "lightcyan", "lightgray")
## y limits
ylim <- range(unlist(lapply(out2$results, function(X) return(c(min(X[,5], na.rm = TRUE),
  max(X[,5], na.rm = TRUE))))))

## Zooming
ylim_zoom <- c(20, 35)

## Plotting the different methods (with/without CIS)
plot.results.dispRity(out2$object, method = 1, colors = colors, colors_CI = colors_CI,
  main = "Stratigraphy", ylim = ylim, CI = TRUE, legend = TRUE)
plot.results.dispRity(out2$object, method = 1, colors = colors, colors_CI = colors_CI,
  main = "Stratigraphy (no CI)", ylim = ylim_zoom, CI = FALSE, time.bins.line = TRUE)

plot.results.dispRity(out2$object, method = 2, colors = colors, colors_CI = colors_CI,
  main = "Duration", ylim = ylim, CI = TRUE)
plot.results.dispRity(out2$object, method = 2, colors = colors, colors_CI = colors_CI,
  main = "Duration (no CI)", ylim = ylim_zoom, CI = FALSE, time.bins.line = TRUE)

plot.results.dispRity(out2$object, method = 3, colors = colors, colors_CI = colors_CI,
  main = "Number", ylim = ylim, CI = TRUE)
plot.results.dispRity(out2$object, method = 3, colors = colors, colors_CI = colors_CI,
  main = "Number(no CI)", ylim = ylim_zoom, CI = FALSE, time.bins.line = TRUE)

```

## Plotting the results histogram style

Another way for the plots would be kind of our histogram representation (you can certainly use `ggplot` here, below is just an example):


### The results per method

```{r, fig.width = 12, fig.height = 18}
## Set the list of available models
models <- list("equalbins", "acctran", "deltran", "punctuated", "gradual")

## Get the stratigraphic, duration and number data for the ages
strat_data_ages <- lapply(models, make.class.histogram, out1$results, method = 1)
durat_data_ages <- lapply(models, make.class.histogram, out1$results, method = 2)
numbe_data_ages <- lapply(models, make.class.histogram, out1$results, method = 3)

## Get the stratigraphic, duration and number data for the epochs
strat_data_epoc <- lapply(models, make.class.histogram, out2$results, method = 1)
durat_data_epoc <- lapply(models, make.class.histogram, out2$results, method = 2)
numbe_data_epoc <- lapply(models, make.class.histogram, out2$results, method = 3)

## The lower age and the lower disparity limit are arbitrarily fixed to 0 and 15 respectively.
lower_age <- 0; lower_lim <- 15
#TG: might want to change that for other datasets!

## limits functions
get.break <- function(x) return(x$breaks)
get.count <- function(x) return(x$counts)
## Ages limits
xlim_ages <- c(max(unlist(c(sapply(strat_data_ages, get.break), sapply(durat_data_ages, get.break),
  sapply(numbe_data_ages, get.break)))), lower_age)
ylim_ages <- c(lower_lim, max(unlist(c(sapply(strat_data_ages, get.count),
  sapply(durat_data_ages, get.count), sapply(numbe_data_ages, get.count)))))
## Epoch limits
xlim_epoc <- c(max(unlist(c(sapply(strat_data_epoc, get.break), sapply(durat_data_epoc, get.break),
  sapply(numbe_data_epoc, get.break)))), lower_age)
ylim_epoc <- c(lower_lim, max(unlist(c(sapply(strat_data_epoc, get.count),
  sapply(durat_data_epoc, get.count), sapply(numbe_data_epoc, get.count)))))

## Colors
colors <- palette()[1:5]
colors[1] <- "grey"

## Graphics
op <- par(bty = "n", mfrow = c(3,2))

## Plot the stratigraphy - ages
plot(strat_data_ages[[1]], xlim = xlim_ages, ylim = ylim_ages , xlab = "Time (Mya)",
  ylab = "Sum of variance", col = colors[1], main = "Stratigraphy - ages")
## Plot the slicing
for(slice in 2:5) {
  lines(strat_data_ages[[slice]]$breaks, strat_data_ages[[slice]]$counts, col = colors[slice])
}

## Adding the legend
legend(x = "bottomleft", legend = c("time bins", "acctran", "deltran", "punctuated", "gradual"),
  col = colors[1:5], lty = 1, bg = "white")

## Plot the stratigraphy - epoch
plot(strat_data_epoc[[1]], xlim = xlim_epoc, ylim = ylim_epoc , xlab = "Time (Mya)",
  ylab = "Sum of variance", col = colors[1], main = "Stratigraphy - Epoch")
## Plot the slicing
for(slice in 2:5) {
  lines(strat_data_epoc[[slice]]$breaks, strat_data_epoc[[slice]]$counts, col = colors[slice])
}


## Plot the duration - ages
plot(durat_data_ages[[1]], xlim = xlim_ages, ylim = ylim_ages , xlab = "Time (Mya)",
  ylab = "Sum of variance", col = colors[1], main = "Duration - ages")
## Plot the slicing
for(slice in 2:5) {
  lines(durat_data_ages[[slice]]$breaks, durat_data_ages[[slice]]$counts, col = colors[slice])
}

## Plot the duration - epoch
plot(durat_data_epoc[[1]], xlim = xlim_epoc, ylim = ylim_epoc , xlab = "Time (Mya)",
  ylab = "Sum of variance", col = colors[1], main = "Duration - Epoch")
## Plot the slicing
for(slice in 2:5) {
  lines(durat_data_epoc[[slice]]$breaks, durat_data_epoc[[slice]]$counts, col = colors[slice])
}


## Plot the number - ages
plot(numbe_data_ages[[1]], xlim = xlim_ages, ylim = ylim_ages , xlab = "Time (Mya)",
  ylab = "Sum of variance", col = colors[1], main = "Number - ages")
## Plot the slicing
for(slice in 2:5) {
  lines(numbe_data_ages[[slice]]$breaks, numbe_data_ages[[slice]]$counts, col = colors[slice])
}

## Plot the number - epoch
plot(numbe_data_epoc[[1]], xlim = xlim_epoc, ylim = ylim_epoc , xlab = "Time (Mya)",
  ylab = "Sum of variance", col = colors[1], main = "Number - Epoch")
## Plot the slicing
for(slice in 2:5) {
  lines(numbe_data_epoc[[slice]]$breaks, numbe_data_epoc[[slice]]$counts, col = colors[slice])
}
```

Some of the plots are a bit off set and everything but it gives us an idea

### The results per model

Something like that but with transparency:

```{r, fig.width = 6, fig.height = 6}
plot(strat_data_epoc[[1]], xlim = xlim_epoc, ylim = ylim_epoc , xlab = "Time (Mya)",
  ylab = "Sum of variance", col = colors[1], main = "Epoch")
plot(durat_data_epoc[[1]], xlim = xlim_epoc, ylim = ylim_epoc , xlab = "Time (Mya)",
  ylab = "Sum of variance", col = colors[2], main = "", add = TRUE)
plot(numbe_data_epoc[[1]], xlim = xlim_epoc, ylim = ylim_epoc , xlab = "Time (Mya)",
  ylab = "Sum of variance", col = colors[3], main = "", add = TRUE)
```



